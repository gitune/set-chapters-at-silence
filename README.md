# set-chapters-at-silence
Set chapters at silence to mp4 movie using ffmpeg

## これは何？

(主にmp4 movieを対象に) 0.5秒以上続く無音区間にチャプターを打つためのperl scriptです。

## 背景と仕組み

日本で放送されているTV CMには、その冒頭と末尾に必ず0.5秒の無音区間(いわゆるノンモン)が設定されています。昔からこの無音区間を利用したCMスキップ機能を持つビデオレコーダー等の商品は数多く存在しました。このscriptは、そういった商品と同様に、CM区間の前後にチャプターを設定することで、スムーズに視聴出来るようにすることを目的としています。

非常に短いscriptですので仕組みは中身を見ていただくのが一番早いと思いますが、以下のようなアルゴリズムで動作します。

1. ffmpegのfilterである `silencedetect` を使い、0.5秒以上続く無音区間を調べます。
2. その無音区間開始時間が、一つ前の無音区間開始時間と比較して `MIN_INTERVAL(=31秒)` より長い場合は、CM区間に入ったと判断してチャプターを打ちます。
   * その際、前回チャプターを打った時間と一つ前の無音区間開始時間が異なる場合は、そこがCM区間終了点と判断してチャプターを打ちます。
3. その無音区間開始時間が、前回の無音区間開始時間と比較して `MIN_INTERVAL(=31秒)` より短い場合は、CM区間中と見なしてチャプターを打ちません。
   * 日本のCMはほとんどが15秒、まれに30秒がある程度で、それ以上の長さのCMが流れることはほとんどありません(逆にそういったCMはレアなのでその前後にチャプターが打たれることは好ましいとも言える)。
4. 上記手順で生成されたチャプター情報を含むmetadataを、ffmpegを使ってmovieに追加します。

なおperlで書かれている理由は、本scriptを実行したかったdocker containerにperlしか入っていなかった、というだけです(perlなんて書いたの10年以上ぶりくらいだ…)。

お楽しみいただければ幸いでした。
